<!DOCTYPE html>
<html>
<head>
    

<style>
    #canvas { 
        border: 1px solid black;
        display: block;
        margin: 0 auto;
    }
    body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
    }
</style>
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
    <div display="flex" justify-content="center" align-items="center">
        <h1>Image Annotation Tool</h1>
        <div style="display: flex;">
            <div>
                <input type="file" id="imageLoader" name="imageLoader" multiple/>
                <canvas id="canvas"></canvas>
                
            </div>
            <div>
                <button id="pushButton">Push</button>
                <button id="saveButton" onclick="saveToFile()">Save</button>
            </div>  
        </div>



    <script>
        var canvas = document.getElementById('canvas');
        var ctx = canvas.getContext('2d');
        var img = new Image();
        var rectangles = [];
        var isDown = false;
        var startX;
        var startY;
        var images = [];
        var currentImageIndex = 0;

        var data_array = [];

        function handleImage(e) {
            var files = e.target.files;
            for (var i = 0; i < files.length; i++) {
                var reader = new FileReader();
                reader.onload = (function(file) {
                    return function(event) {
                        images.push(event.target.result);
                        if (file === files[0]) {
                            loadImage();
                        }
                    }
                })(files[i]);
                reader.readAsDataURL(files[i]);
            }
        }

        function loadImage() {
            img.onload = function() {
                var maxWidth = 600; // Max width for the image
                var ratio = 0;  // Used for aspect ratio

                // Check if the current width is larger than the max
                if(img.width > maxWidth){
                    ratio = maxWidth / img.width;   // get ratio for scaling image
                    canvas.width = maxWidth;
                    canvas.height = img.height * ratio;
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                } else {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0, img.width, img.height);
                }
            }
            img.src = images[currentImageIndex];
        }

        function handleMouseDown(e) {
            startX = e.clientX - canvas.offsetLeft;
            startY = e.clientY - canvas.offsetTop;
            isDown = true;
        }

        function handleMouseMove(e) {
            if (!isDown) return;
            var x = e.clientX - canvas.offsetLeft;
            var y = e.clientY - canvas.offsetTop;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            ctx.strokeStyle = 'red';
            ctx.strokeRect(startX, startY, x - startX, y - startY);
        }

        function handleMouseUp(e) {
            if (!isDown) return;
            isDown = false;
            var rectWidth = (e.clientX - canvas.offsetLeft) - startX;
            var rectHeight = (e.clientY - canvas.offsetTop) - startY;
            ctx.strokeStyle = 'red';
            ctx.strokeRect(startX, startY, rectWidth, rectHeight);
            rectangles.push({x: startX, y: startY, width: rectWidth, height: rectHeight});
        }

        function pushData() {
            var data = {
                imageWidth: img.width,
                imageHeight: img.height,
                rectangles: rectangles
            };
            rectangles = [];
            data_array.push(data);
            currentImageIndex++;
            if (currentImageIndex < images.length) {
                loadImage();
            }else{
                saveToFile();
                //erase the canvas
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
            }
        }

        function saveToFile() {
            var json = JSON.stringify(data_array);
            var blob = new Blob([json], {type: "application/json"});
            var url  = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.download = 'annotations.json';
            a.href = url;
            a.click();
            rectangles = [];
           
        }

        document.getElementById('imageLoader').addEventListener('change', handleImage, false);
        canvas.addEventListener('mousedown', handleMouseDown, false);
        canvas.addEventListener('mousemove', handleMouseMove, false);
        canvas.addEventListener('mouseup', handleMouseUp, false);
        document.getElementById('pushButton').addEventListener('click', pushData, false);
    </script>
</body>
</html>


